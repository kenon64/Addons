#!/bin/bash
# ============================================================
# –°–∫—Ä–∏–ø—Ç —Å–±–æ—Ä–∫–∏ DotaCoach –¥–ª—è Linux/Mac
# ============================================================

echo ""
echo "===================================="
echo "  üéÆ –°–ë–û–†–ö–ê DotaCoach"
echo "===================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ python
if ! command -v python3 &> /dev/null; then
    echo "‚ùå Python3 –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python 3."
    exit 1
fi

echo "‚úì Python3 –Ω–∞–π–¥–µ–Ω: $(python3 --version)"

# –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo ""
echo "üîß –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."

if [ ! -d "venv" ]; then
    echo "  –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
    python3 -m venv venv
fi

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
source venv/bin/activate
echo "‚úì –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo ""
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
pip install -r requirements.txt --quiet

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
    exit 1
fi

echo "‚úì –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ PyInstaller
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ PyInstaller..."
if ! pip show PyInstaller &> /dev/null; then
    echo "  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PyInstaller..."
    pip install PyInstaller==6.1.0 --quiet
fi

echo "‚úì PyInstaller –≥–æ—Ç–æ–≤"

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–±–æ—Ä–æ–∫
echo ""
echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤..."
rm -rf build dist __pycache__ 2>/dev/null
echo "‚úì –û—á–∏—â–µ–Ω–æ"

# –°–±–æ—Ä–∫–∞
echo ""
echo "üî® –°–±–æ—Ä–∫–∞ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞..."
echo "   (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç)"
echo ""

pyinstaller --onefile \
    --name "DotaCoach" \
    --add-data ".env.example:." \
    --hidden-import=speech_recognition \
    --hidden-import=pyttsx3 \
    --hidden-import=requests \
    --hidden-import=psutil \
    --hidden-import=dotenv \
    main.py

if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ!"
    exit 1
fi

echo ""
echo "===================================="
echo "   ‚úÖ –°–ë–û–†–ö–ê –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–ê!"
echo "===================================="
echo ""
echo "üìÅ –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª: dist/DotaCoach"
echo ""
echo "üìù –ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º:"
echo "   1. –°–∫–æ–ø–∏—Ä—É–π .env —Ñ–∞–π–ª –≤ –ø–∞–ø–∫—É —Å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º —Ñ–∞–π–ª–æ–º"
echo "   2. –î–æ–±–∞–≤—å QWEN_API_KEY –≤ .env"
echo "   3. –ó–∞–ø—É—Å—Ç–∏: ./dist/DotaCoach"
echo ""

# –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
deactivate

echo "‚úÖ –ì–æ—Ç–æ–≤–æ!"
